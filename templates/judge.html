<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Family Feud - Judge</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js" integrity="" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
      /* Judge-specific theme overrides (scoped to body.judge-theme) */
      body.judge-theme {
        background: linear-gradient(135deg, #081a3a 0%, #0f2b55 100%);
        color: #cfcfcf;
      }
      body.judge-theme .title { color: #d7e6ff; text-shadow: none; }
      body.judge-theme .team-box { background: rgba(255,255,255,0.03); border-color: transparent; }
      body.judge-theme .team-name, body.judge-theme .team-indicator { color: #aab6c8; }
      body.judge-theme .team-score { color: #e6eefc; }
      body.judge-theme .question { background: rgba(255,255,255,0.04); }
      body.judge-theme .question-text { color: #d6e6ff; }
      body.judge-theme .round-score-box { background: rgba(255,255,255,0.03); }
      body.judge-theme .answer { background: rgba(255,255,255,0.02); color: #cfcfcf; border-color: rgba(255,255,255,0.04); }
      /* keep revealed answers bright to preserve readability */
      body.judge-theme .revealed { background: linear-gradient(90deg,#e6f0ff, #99c2ff); color: #091019; }
      /* Hide spin arrows for number inputs (scoped to judge theme) */
      body.judge-theme input[type=number]::-webkit-outer-spin-button,
      body.judge-theme input[type=number]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      body.judge-theme input[type=number] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
        appearance: textfield;
      }
    </style>
  </head>
  <body class="judge-theme">
  <div class="container">
    <div class="header">
      <div class="title">Family Feud Judge Controls</div>
    </div>

    <div class="teams-section">
      <div class="team-box" id="team1Box" role="button" tabindex="0" aria-pressed="false">
        <div class="team-name" id="team1Name">Team 1</div>
        <div class="team-score" id="team1Score">0</div>
        <div class="team-indicator">● PLAYING ●</div>
        <div class="team-score-control">
          <input type="number" id="team1ScoreInput" aria-label="Team 1 score" placeholder="0" style="width:90px; margin-top:8px;">
          <button id="btnSetTeam1Score" class="btn-primary control-btn" style="height:36px; margin-left:8px;">Set Score</button>
        </div>
      </div>
      <div class="team-box" id="team2Box" role="button" tabindex="0" aria-pressed="false">
        <div class="team-name" id="team2Name">Team 2</div>
        <div class="team-score" id="team2Score">0</div>
        <div class="team-indicator">● PLAYING ●</div>
        <div class="team-score-control">
          <input type="number" id="team2ScoreInput" aria-label="Team 2 score" placeholder="0" style="width:90px; margin-top:8px;">
          <button id="btnSetTeam2Score" class="btn-primary control-btn" style="height:36px; margin-left:8px;">Set Score</button>
        </div>
      </div>
    </div>

    <div class="question">
      <div class="question-text" id="question">Loading...</div>
      <div class="question-counter" id="questionCounter"></div>
    </div>
    <div class="round-score-box">
      <div class="round-score-label">ROUND SCORE</div>
      <div class="round-score-value" id="roundScore">0</div>
    </div>
    <div class="strikes">
      <div class="strike" id="strike1">X</div>
      <div class="strike" id="strike2">X</div>
      <div class="strike" id="strike3">X</div>
      <div class="strike-controls">
        <button id="addStrikeBtn" class="btn-danger control-btn">Add Strike</button>
        <button id="clearStrikesBtn" class="btn-primary control-btn">Clear Strikes</button>
      </div>
    </div>
  <div id="answers"></div>

    <!-- Control sections: Team Controls and Game Controls (matches ex.html style) -->
  <div class="controls-section">
      <div class="control-panel" id="teamControls">
        <div class="control-title">Team Controls</div>
        <div class="controls">
          <!-- <button class="btn-primary control-btn" id="btnSetTeam1">Set Team 1 Playing</button>
          <button class="btn-primary control-btn" id="btnSetTeam2">Set Team 2 Playing</button> -->
          <button class="btn-secondary control-btn" id="btnAwardPoints">Award Points</button>
          <button class="btn-warning control-btn" id="btnSteal">Award Steal</button>
        </div>
      </div>

      <div class="control-panel" id="gameControls">
        <div class="control-title">Game Controls</div>
        <div class="controls">
          <button class="btn-secondary control-btn" id="btnRevealAll">Reveal All</button>
          <!-- <button class="btn-danger control-btn" id="btnClearStrikesBottom">Clear Strikes</button> -->
          <button class="btn-warning control-btn" id="btnNextRound">Next Round</button>
        </div>
      </div>
    </div>

    <script>
      // page-level render function used by /static/app.js
      window.renderState = function (state) {
        document.getElementById('question').innerText = state.question || '';
        // update question counter (revealed / total) and question number
        const revealedCount = (state.answers || []).filter(a => a.revealed).length;
        const totalCount = (state.answers || []).length;
        const counterEl = document.getElementById('questionCounter');
        if (counterEl) {
          const questionId = state.current_question_id || 1;
          counterEl.textContent = `Question ${questionId} • ${revealedCount} / ${totalCount} revealed`;
        }
          // update round score
          const roundEl = document.getElementById('roundScore');
          if (roundEl) roundEl.textContent = (state.roundScore ?? 0);
        const container = document.getElementById('answers');
        container.innerHTML = '';
        (state.answers || []).forEach(a => {
          const div = document.createElement('div');
          div.className = 'answer' + (a.revealed ? ' revealed' : '');
          div.innerText = `${a.id}. ${a.text} — ${a.points}`;
          div.onclick = () => selectAnswer(a.id);
          container.appendChild(div);
        });
        // reflect active team in the judge UI
        const t1 = document.getElementById('team1PlayBtn');
        const t2 = document.getElementById('team2PlayBtn');
        const box1 = document.getElementById('team1Box');
        const box2 = document.getElementById('team2Box');
        if (t1 && t2) {
          if ((state.activeTeam || 1) === 1) { t1.classList.add('active'); t2.classList.remove('active'); }
          else { t2.classList.add('active'); t1.classList.remove('active'); }
        }
        if (box1 && box2) {
          if ((state.activeTeam || 1) === 1) { box1.classList.add('active'); box2.classList.remove('active'); box1.setAttribute('aria-pressed', 'true'); box2.setAttribute('aria-pressed', 'false'); }
          else { box2.classList.add('active'); box1.classList.remove('active'); box2.setAttribute('aria-pressed', 'true'); box1.setAttribute('aria-pressed', 'false'); }
        }
        // update strikes display (judge view)
        const strikes = state.strikes || 0;
        for (let i = 1; i <= 3; i++) {
          const el = document.getElementById(`strike${i}`);
          if (!el) continue;
          if (i <= strikes) el.classList.add('active'); else el.classList.remove('active');
        }
      };

      async function selectAnswer(id) {
        const res = await fetch('/api/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        if (!res.ok) alert('Error selecting answer');
      }

      // reset button removed; use Next Round or Reveal controls instead
      // make the team boxes clickable in judge view
      const teamBox1 = document.getElementById('team1Box');
      const teamBox2 = document.getElementById('team2Box');
      if (teamBox1) {
        teamBox1.addEventListener('click', async () => { await fetch('/api/active', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 1 }) }); });
        teamBox1.addEventListener('keydown', async (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); await fetch('/api/active', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 1 }) }); } });
      }
      if (teamBox2) {
        teamBox2.addEventListener('click', async () => { await fetch('/api/active', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 2 }) }); });
        teamBox2.addEventListener('keydown', async (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); await fetch('/api/active', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 2 }) }); } });
      }
      // add strike button
      const addStrikeBtn = document.getElementById('addStrikeBtn');
      if (addStrikeBtn) {
        addStrikeBtn.addEventListener('click', async () => { await fetch('/api/strike', { method: 'POST' }); });
      }
      const clearStrikesBtn = document.getElementById('clearStrikesBtn');
      if (clearStrikesBtn) {
        clearStrikesBtn.addEventListener('click', async () => { await fetch('/api/clear_strikes', { method: 'POST' }); });
      }

      // bottom control buttons
      const btnSetTeam1 = document.getElementById('btnSetTeam1');
      const btnSetTeam2 = document.getElementById('btnSetTeam2');
      const btnRevealAll = document.getElementById('btnRevealAll');
      const btnClearStrikesBottom = document.getElementById('btnClearStrikesBottom');
      const btnNextRound = document.getElementById('btnNextRound');
      const btnAwardPoints = document.getElementById('btnAwardPoints');
      const btnSteal = document.getElementById('btnSteal');

      if (btnSetTeam1) btnSetTeam1.addEventListener('click', async () => { await fetch('/api/active', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 1 }) }); });
      if (btnSetTeam2) btnSetTeam2.addEventListener('click', async () => { await fetch('/api/active', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 2 }) }); });

      if (btnSteal) btnSteal.addEventListener('click', async () => {
        const res = await fetch('/api/award_steal', { method: 'POST' });
        if (!res.ok) alert('Award steal failed');
      });

      if (btnRevealAll) btnRevealAll.addEventListener('click', async () => {
        // reveal all answers by selecting each id
        const stateRes = await fetch('/api/state');
        if (!stateRes.ok) return alert('Unable to fetch state');
        const state = await stateRes.json();
        for (const a of (state.answers || [])) {
          if (!a.revealed) await fetch('/api/select', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: a.id }) });
        }
      });

      if (btnClearStrikesBottom) btnClearStrikesBottom.addEventListener('click', async () => { await fetch('/api/clear_strikes', { method: 'POST' }); });

      if (btnNextRound) btnNextRound.addEventListener('click', async () => {
        // Complete next round: award points, load new question, reset round state
        try {
          const res = await fetch('/api/next_round', { method: 'POST' });
          if (!res.ok) {
            const error = await res.json();
            alert(`Next round failed: ${error.error || 'Unknown error'}`);
          }
        } catch (e) {
          alert(`Next round failed: ${e.message}`);
        }
      });

      if (btnAwardPoints) btnAwardPoints.addEventListener('click', async () => {
        const res = await fetch('/api/award', { method: 'POST' });
        if (!res.ok) alert('Award failed');
      });

      // judge manual score set buttons
      const btnSetTeam1Score = document.getElementById('btnSetTeam1Score');
      const btnSetTeam2Score = document.getElementById('btnSetTeam2Score');
      if (btnSetTeam1Score) btnSetTeam1Score.addEventListener('click', async () => {
        const val = document.getElementById('team1ScoreInput').value;
        const score = parseInt(val, 10);
        if (isNaN(score)) return alert('Enter a valid number for Team 1');
        const res = await fetch('/api/set_score', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 1, score }) });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          return alert(`Failed to set score: ${err.error || res.statusText}`);
        }
      });
      if (btnSetTeam2Score) btnSetTeam2Score.addEventListener('click', async () => {
        const val = document.getElementById('team2ScoreInput').value;
        const score = parseInt(val, 10);
        if (isNaN(score)) return alert('Enter a valid number for Team 2');
        const res = await fetch('/api/set_score', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ team: 2, score }) });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          return alert(`Failed to set score: ${err.error || res.statusText}`);
        }
      });
    </script>
    <script src="/static/app.js"></script>
  </body>
  </html>
